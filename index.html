<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FDFBF7">
    <title>Êù±‰∫¨ÊóÖË®ò Tokyo Trip Pro</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Shippori+Mincho:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --bg-color: #FDFBF7;
            --card-bg: #FFFFFF;
            --text-primary: #4A4036;
            --text-secondary: #8C837B;
            --accent: #C7B398;
            --highlight: #D4A373;
            --nav-active: #8D7B68;
            --shadow: 0 4px 12px rgba(74, 64, 54, 0.08);
            --radius: 16px;
            --danger: #ff6b6b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0; padding-bottom: 90px;
        }

        header {
            position: sticky; top: 0; background: rgba(253, 251, 247, 0.95);
            backdrop-filter: blur(10px); padding: 15px 20px; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            padding-top: max(15px, env(safe-area-inset-top));
        }
        .app-title { font-family: 'Shippori Mincho', serif; font-size: 1.4rem; font-weight: 600; }

        .add-btn {
            background: var(--highlight); color: white; border: none;
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: var(--shadow);
            transition: transform 0.1s;
        }
        .add-btn:active { transform: scale(0.9); }

        .tabs-wrapper { overflow-x: auto; white-space: nowrap; padding: 10px 20px; scrollbar-width: none; }
        .tabs-wrapper::-webkit-scrollbar { display: none; }
        .tab-item {
            display: inline-block; padding: 8px 18px; margin-right: 10px;
            border-radius: 20px; font-size: 0.9rem; color: var(--text-secondary);
            background: #F2EFE9; transition: all 0.3s; cursor: pointer;
        }
        .tab-item.active { background: var(--nav-active); color: #fff; box-shadow: var(--shadow); }

        .section-container { padding: 0 20px; animation: fadeIn 0.4s ease; }
        
        /* Â§©Ê∞£Âç°ÁâáÂÑ™Âåñ */
        .weather-card {
            background: linear-gradient(135deg, #FFFDF9 0%, #F5F1E8 100%);
            border-radius: var(--radius); padding: 15px; margin-bottom: 15px;
            box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 10px;
        }
        .weather-main { display: flex; align-items: center; gap: 15px; justify-content: space-between; }
        .temp-display { font-size: 1.8rem; font-family: 'Shippori Mincho'; font-weight: 600; }
        .outfit-box { background: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; font-size: 0.85rem; border: 1px solid #EEE; }

        /* ÊôÇÊÆµÂ§©Ê∞£ Scroll */
        .hourly-weather-scroll {
            display: flex; gap: 10px; overflow-x: auto; padding: 5px 0;
            border-top: 1px solid rgba(0,0,0,0.05); margin-top: 5px;
        }
        .hourly-item {
            min-width: 70px; background: rgba(255,255,255,0.5); border-radius: 8px;
            padding: 8px 5px; text-align: center; display: flex; flex-direction: column; gap: 4px;
        }
        .h-time { font-size: 0.75rem; color: var(--text-secondary); font-weight: 700; }
        .h-icon { font-size: 1.2rem; }
        .h-temp { font-size: 0.9rem; font-weight: 600; }

        .hotel-card {
            background: #FFFFFF; border-left: 4px solid var(--accent);
            border-radius: 8px; padding: 12px 16px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); font-size: 0.9rem;
        }

        .sortable-ghost { opacity: 0.3; background: var(--accent) !important; }
        .sortable-chosen { box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important; }

        .timeline-item {
            background: var(--card-bg); border-radius: var(--radius); margin-bottom: 12px;
            display: flex; box-shadow: var(--shadow); position: relative;
        }
        .map-trigger {
            width: 50px; background: #F4F1EC; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 0.7rem; color: var(--highlight);
            border-radius: var(--radius) 0 0 var(--radius); cursor: pointer;
        }
        .item-content { flex: 1; padding: 12px; position: relative;}
        .delete-item-btn { position: absolute; top: 10px; right: 10px; color: #eee; cursor: pointer; }
        .timeline-item:hover .delete-item-btn { color: var(--danger); }
        
        .item-time { font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); display: inline-block; margin-bottom: 4px; }
        .item-title { font-size: 1rem; font-weight: 600; margin: 2px 0; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: #eee; }
        .tag.food { background: #FFECB3; } .tag.transport { background: #E1F5FE; } .tag.shop { background: #F8BBD0; }
        
        /* Â∏≥Êú¨Ê®£Âºè */
        .ledger-input-group { background: #FFF; padding: 15px; border-radius: var(--radius); margin-bottom: 20px; box-shadow: var(--shadow); }
        .ledger-input-group input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #EEE; border-radius: 8px; font-size: 1rem; }
        .ledger-item { background: #FFF; padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;}
        .delete-ledger { color: #ddd; margin-left: 10px; cursor: pointer; padding: 5px; }
        .delete-ledger:hover { color: var(--danger); }
        .total-banner { background: var(--nav-active); color: white; padding: 20px; border-radius: var(--radius); text-align: center; margin-top: 20px; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: #FFF;
            display: flex; justify-content: space-around; padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid #EEE; z-index: 100;
        }
        .nav-btn { border: none; background: none; color: #BBB; font-size: 0.7rem; text-align: center; cursor: pointer; }
        .nav-btn.active { color: var(--nav-active); }
        .nav-btn i { font-size: 1.2rem; display: block; margin-bottom: 4px; }

        /* ÊîªÁï•ÂàóË°®ÂÑ™Âåñ (ÂèØÁ∑®ËºØÁâà) */
        .guide-section { margin-bottom: 25px; position: relative; }
        .guide-title { font-weight: 700; color: var(--highlight); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .guide-card { background: #FFF; padding: 15px; border-radius: 12px; box-shadow: var(--shadow); position: relative; }
        .guide-card ul { margin: 0; padding-left: 18px; color: var(--text-primary); font-size: 0.9rem; line-height: 1.8; }
        .guide-card li { margin-bottom: 5px; }
        .guide-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
        .btn-icon { background: none; border: none; cursor: pointer; color: #ccc; font-size: 0.9rem; }
        .btn-icon.del:hover { color: var(--danger); }
        .btn-icon.add:hover { color: var(--highlight); }

        [contenteditable="true"]:focus { background: #fffdf0; outline: 1px solid var(--highlight); border-radius: 4px; min-width: 20px; }
        @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
    </style>
</head>
<body>

    <div id="page-itinerary">
        <header>
            <div class="app-title">Êù±‰∫¨ÊóÖË®ò <span style="font-size:0.8rem; color:#888;">Dec 25-31</span></div>
            <button class="add-btn" onclick="addItem()" title="Êñ∞Â¢ûË°åÁ®ã"><i class="fas fa-plus"></i></button>
        </header>
        <div class="tabs-wrapper" id="day-tabs"></div>
        <div id="day-content" class="section-container"></div>
    </div>

    <div id="page-notices" style="display:none;">
        <header>
            <div class="app-title">ÊóÖË°åÂøÖÁúãÊîªÁï•</div>
            <button class="add-btn" onclick="addGuideSection()" title="Êñ∞Â¢ûÊîªÁï•ÂçÄÂ°ä"><i class="fas fa-plus"></i></button>
        </header>
        <div class="section-container" style="padding-top:20px;" id="guide-list-container">
            </div>
    </div>

    <div id="page-ledger" style="display:none;">
        <header>
            <div class="app-title">ÊóÖÈÅäÂ∏≥Êú¨</div>
            <button class="add-btn" onclick="clearLedger()" style="background:#ddd;" title="Ê∏ÖÁ©∫Â∏≥Êú¨"><i class="fas fa-trash"></i></button>
        </header>
        <div class="section-container" style="padding-top:20px;">
            <div class="ledger-input-group">
                <input type="text" id="expense-name" placeholder="È†ÖÁõÆÂêçÁ®± (Â¶ÇÔºöÂçàÈ§ê)">
                <input type="number" id="expense-jpy" placeholder="Êó•Âπ£ÈáëÈ°ç (JPY)">
                <button onclick="addLedgerItem()" style="width:100%; padding:10px; background:var(--highlight); color:white; border:none; border-radius:8px; margin-top:10px; font-weight:bold;">Ë®òÈåÑÊîØÂá∫</button>
            </div>
            
            <div id="ledger-list"></div>

            <div class="total-banner">
                <div style="font-size:0.9rem; opacity:0.9;">Á∏ΩÈ†êÁÆó (Âè∞Âπ£) ÂåØÁéá 0.215</div>
                <div id="total-twd" style="font-size:1.8rem; font-weight:700; margin:10px 0;">NT$ 0</div>
                <div id="split-result" style="font-size:1rem; border-top:1px solid rgba(255,255,255,0.3); padding-top:10px;">
                    4 ‰∫∫ÂàÜÂ∏≥ÔºöÊØè‰∫∫ NT$ 0
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchPage('itinerary')"><i class="fas fa-calendar-alt"></i> Ë°åÁ®ã</button>
        <button class="nav-btn" onclick="switchPage('ledger')"><i class="fas fa-wallet"></i> Â∏≥Êú¨</button>
        <button class="nav-btn" onclick="switchPage('notices')"><i class="fas fa-info-circle"></i> ÊîªÁï•</button>
    </nav>

    <script>
        const JPY_RATE = 0.215; 
        
        // --- ÈªòË™çË≥áÊñô ---
        const defaultTripData = {
            day1: {
                date: "12/25 (‰∏â)",
                weather: { 
                    temp: "8¬∞C", icon: "‚òÅÔ∏è", desc: "ÂÜ∑Ê∂ºÈô∞Â§©", outfit: "ÁôºÁÜ±Ë°£+ÊØõË°£+Èò≤È¢®Â§ßË°£„ÄÇ",
                    hourly: [
                        { time: '18:00', icon: '‚òÅÔ∏è', temp: '8¬∞C' },
                        { time: '20:00', icon: '‚òÅÔ∏è', temp: '7¬∞C' },
                        { time: '22:00', icon: 'üåô', temp: '6¬∞C' }
                    ]
                },
                hotel: "üè† ‰ΩèÂÆø: 3 Chome-4-1 Narihira (Êäº‰∏äÁ´ô)",
                note: "ÊäµÈÅîÊó•ÈáçÈªûÔºöSkyliner È†òÁ•®ËàáÈùíÁ†•Á´ôËΩâ‰πò„ÄÇ",
                items: [
                    { time: '18:30', title: 'ÊäµÈÅîÊàêÁî∞Ê©üÂ†¥ (NRT)', type: 'transport', addr: 'Narita Airport', desc: 'ÂÖ•Â¢ÉÂØ©Êü•ËàáÈ†òÂèñ Skyliner ËªäÁ•®„ÄÇ' },
                    { time: '19:30', title: 'Êê≠‰πò‰∫¨Êàê Skyliner', type: 'transport', addr: 'Narita Airport Station', desc: 'ÂæÄ‰∫¨Êàê‰∏äÈáéÊñπÂêëÔºåÈùíÁ†•Á´ô‰∏ãËªä„ÄÇ' },
                    { time: '21:30', title: 'ÊôöÈ§êÔºöÂÖ≠ÂéòËàç', type: 'food', addr: 'Êô¥Á©∫Â°î Solamachi 6F', desc: 'Ê≤æÈ∫µÂêçÂ∫óÔºåL.O. 22:30„ÄÇ' }
                ]
            },
            day2: {
                date: "12/26 (Âõõ)",
                weather: { 
                    temp: "6¬∞C", icon: "‚òÄÔ∏è", desc: "Êô¥Êúó‰ΩéÊ∫´", outfit: "Ëø™Â£´Â∞ºÈù†Êµ∑È¢®Â§ßÔºåÂª∫Ë≠∞‰Ω©Êà¥ÂúçÂ∑æ„ÄÇ",
                    hourly: [
                        { time: '08:00', icon: '‚òÄÔ∏è', temp: '4¬∞C' },
                        { time: '12:00', icon: '‚òÄÔ∏è', temp: '8¬∞C' },
                        { time: '18:00', icon: 'üåô', temp: '5¬∞C' }
                    ]
                },
                hotel: "üè† ‰ΩèÂÆø: 3 Chome-4-1 Narihira",
                note: "Ëø™Â£´Â∞ºÂÖ®Êó•ÊîªÁï•ÔºöÂÖ•ÂúíÂÖàÊê∂ DPA ËàáÈ†êÁ¥ÑÁ≠âÂÄôÂç°„ÄÇ",
                items: [
                    { time: '09:00', title: 'Êù±‰∫¨Ëø™Â£´Â∞ºÊ®ÇÂúíÂÖ•Âúí', type: 'spot', addr: 'Tokyo Disneyland', desc: 'Á¨¨‰∏ÄË¶ÅÂãôÔºöË≥ºË≤∑„ÄåÁæéÂ•≥ËàáÈáéÁç∏„ÄçDPA„ÄÇ' },
                    { time: '21:00', title: 'Â§úÈñìÁÖôÁÅ´ / ÈÅäË°å', type: 'spot', addr: 'Tokyo Disneyland', desc: 'Â§¢‰πãÂÖâÈõªÂ≠êÂ§ßÈÅäË°åËàáÁÖôÁÅ´ÁßÄ„ÄÇ' }
                ]
            },
            day3: {
                date: "12/27 (‰∫î)",
                weather: { 
                    temp: "9¬∞C", icon: "üå§Ô∏è", desc: "ËàíÈÅ©Â§öÈõ≤", outfit: "ÂíåÊúçÈ´îÈ©óÊó•ÔºåÂÖßÁ©øËñÑÁôºÁÜ±Ë°£„ÄÇ",
                    hourly: [
                        { time: '10:00', icon: 'üå§Ô∏è', temp: '8¬∞C' },
                        { time: '14:00', icon: '‚òÅÔ∏è', temp: '10¬∞C' },
                        { time: '19:00', icon: 'üåô', temp: '8¬∞C' }
                    ]
                },
                hotel: "üè† ‰ΩèÂÆø: 3 Chome-4-1 Narihira",
                note: "ÈäÄÂ∫ßË≥ºÁâ©Á∑öÔºöLoft -> MUJI -> Uniqlo„ÄÇ",
                items: [
                    { time: '10:00', title: 'Ê∑∫ËçâÊÑõÂíåÊúçÈ´îÈ©ó', type: 'spot', addr: 'Ê∑∫ËçâÊÑõÂíåÊúç3ËôüÂ∫ó', desc: 'ÊèõË£ùÂæåÈõ∑ÈñÄ„ÄÅ‰ª≤Ë¶ã‰∏ñÈÄöËßÄÂÖâ„ÄÇ' },
                    { time: '13:00', title: 'ÂçàÈ§êÔºöÊ∑∫Ëçâ‰ªäÂçä', type: 'food', addr: 'Asakusa Imahan', desc: 'Â£ΩÂñúÁáíÁôæÂπ¥ËÄÅÂ∫óÔºàÂ∑≤È†êÁ¥ÑÔºâ„ÄÇ' },
                    { time: '16:00', title: 'ÈäÄÂ∫ßË≥ºÁâ©Ë°åÁ®ã', type: 'shop', addr: 'Ginza Loft', desc: 'Âê´ Loft„ÄÅMUJI ÊóóËâ¶Â∫óÁ≠â„ÄÇ' }
                ]
            },
            day4: {
                date: "12/28 (ÂÖ≠)",
                weather: { 
                    temp: "2¬∞C", icon: "üóª", desc: "Ê≤≥Âè£ÊπñÂØíÂÜ∑", outfit: "Â±±ÂçÄÊ•µÂØíÔºåÈ†àÁ©øËëóÂéöÁæΩÁµ®Ë°£„ÄÅÊâãÂ•ó„ÄÇ",
                    hourly: [
                        { time: '09:00', icon: '‚òÅÔ∏è', temp: '3¬∞C' },
                        { time: '12:00', icon: '‚òÄÔ∏è', temp: '5¬∞C' },
                        { time: '17:00', icon: 'üåô', temp: '0¬∞C' }
                    ]
                },
                hotel: "üè† ‰ΩèÂÆø: Ê∑∫Â∑ù 180-1 (Ê≤≥Âè£Êπñ)",
                note: "Ê≤≥Âè£ÊπñÁßªÂãïÊó•ÔºöÂ§ßË°åÊùéÂØÑÊîæÊñ∞ÂÆøÁ´ô„ÄÇ",
                items: [
                    { time: '10:00', title: 'Êñ∞ÂÆøÂ∑¥Â£´Á´ôÂá∫Áôº', type: 'transport', addr: 'Shinjuku Bus Terminal', desc: 'ÂâçÂæÄÊ≤≥Âè£ÊπñÔºåËªäÁ®ãÁ¥Ñ 2 Â∞èÊôÇ„ÄÇ' },
                    { time: '15:30', title: 'Â§ßÁü≥ÂÖ¨Âúí (Á¥ÖÁ∑öÂ∑¥Â£´)', type: 'spot', addr: 'Oishi Park', desc: 'ÊãçÊîùÂØåÂ£´Â±±ÁµïÊôØ„ÄÇ' }
                ]
            },
            day5: {
                date: "12/29 (Êó•)",
                weather: { 
                    temp: "3¬∞C", icon: "‚òÄÔ∏è", desc: "Â±±ÂçÄÊô¥Êúó", outfit: "‰øùÊöñÁæΩÁµ®Ë°£„ÄÅÈò≤ÊªëÈûã„ÄÇÊó©ÊôöÊ∫´Â∑ÆÊ•µÂ§ß„ÄÇ",
                    hourly: [
                        { time: '08:00', icon: '‚òÄÔ∏è', temp: '-2¬∞C' },
                        { time: '12:00', icon: '‚òÄÔ∏è', temp: '4¬∞C' },
                        { time: '18:00', icon: 'üåô', temp: '1¬∞C' }
                    ]
                },
                hotel: "üè† ‰ΩèÂÆø: Ê±üÊà∂Â∑ùÂçÄÊùæÂ≥∂ (Êñ∞Â∞èÂ≤©)",
                note: "Êñ∞ÂÄâÂØåÂ£´Ê∑∫ÈñìÁ•ûÁ§æÈ†àÁà¨ÈöéÊ¢ØÔºåÂª∫Ë≠∞Á©øÂ•ΩËµ∞ÁöÑÈûã„ÄÇ",
                items: [
                    { time: '09:25', title: 'Êñ∞ÂÄâÂØåÂ£´Ê∑∫ÈñìÁ•ûÁ§æ', type: 'spot', addr: 'Chureito Pagoda', desc: 'Á∂ìÂÖ∏‰∫îÈáçÂ°î+ÂØåÂ£´Â±±ÊãçÊîùÈªû„ÄÇ' },
                    { time: '18:30', title: 'ÊôöÈ§êÔºöÊñ∞ÂÆøÁáíËÇâ Bondz', type: 'food', addr: 'Êñ∞ÂÆø', desc: 'ËøîÂõûÊñ∞ÂÆøÂæå‰∫´Áî®ÁáíËÇâ„ÄÇ' }
                ]
            },
            day6: {
                date: "12/30 (‰∏Ä)",
                weather: { 
                    temp: "8¬∞C", icon: "üõçÔ∏è", desc: "Â∏ÇÂçÄÂÜ∑", outfit: "Á©øËëóËàíÈÅ©ÁöÑÊ≠•Ë°åÈûãÔºåÈÄôÂ§©Ë°åÁ®ãË≥ºÁâ©ËºÉÂ§ö„ÄÇ",
                    hourly: [
                        { time: '10:00', icon: 'üå§Ô∏è', temp: '7¬∞C' },
                        { time: '15:00', icon: '‚òÅÔ∏è', temp: '9¬∞C' },
                        { time: '20:00', icon: 'üåô', temp: '6¬∞C' }
                    ]
                },
                hotel: "üè† ‰ΩèÂÆø: Êñ∞Â∞èÂ≤© (ÈÄ£‰Ωè)",
                note: "ÊúÄÂæåÊéÉË≤®Ôºö‰∏äÈáé‰∫åÊú®‰πãËèìÂ≠ê„ÄÅÊæÄË∞∑ Sky Â§úÊôØ„ÄÇ",
                items: [
                    { time: '10:00', title: '‰∏äÈáéÈòøÁæéÊ©´‰∏Å', type: 'shop', addr: '‰∫åÊú®‰πãËèìÂ≠ê', desc: 'Ë≥ºË≤∑‰º¥ÊâãÁ¶Æ„ÄÅËó•Â¶ù„ÄÇ' },
                    { time: '14:00', title: 'Shibuya Sky ÊæÄË∞∑Â§©Á©∫', type: 'spot', addr: 'ÊæÄË∞∑', desc: '‰øØÁû∞Êù±‰∫¨Â§úÊôØ„ÄÇ' }
                ]
            },
            day7: {
                date: "12/31 (‰∫å)",
                weather: { 
                    temp: "7¬∞C", icon: "‚úàÔ∏è", desc: "Êô¥ËΩâÂ§öÈõ≤", outfit: "Á©øËëóÊúÄÂéöÂØ¶ÁöÑË°£Áâ©‰∏äÊ©ü„ÄÇ",
                    hourly: [
                        { time: '12:00', icon: 'üå§Ô∏è', temp: '8¬∞C' },
                        { time: '15:00', icon: '‚òÅÔ∏è', temp: '7¬∞C' },
                        { time: '18:00', icon: 'üåô', temp: '5¬∞C' }
                    ]
                },
                hotel: "üè† ËøîÂõûÊ∫´ÊöñÁöÑÂÆ∂",
                note: "Ê©üÂ†¥ÂÖçÁ®ÖÂ∫óÊúÄÂæåË°ùÂà∫ÔºöË≤∑ Financier Henri Charpentier„ÄÇ",
                items: [
                    { time: '14:30', title: 'ÂâçÂæÄÊ©üÂ†¥', type: 'transport', addr: 'NRT', desc: 'ÊèêÊó©ÊäµÈÅîÈÄõÂÖçÁ®ÖÂ∫ó„ÄÇ' },
                    { time: '19:30', title: 'Áè≠Ê¨° CI109 Ëµ∑È£õ', type: 'transport', addr: 'Narita Airport', desc: 'ÁµêÊùüÁæéÂ•ΩÊóÖÁ®ã„ÄÇ' }
                ]
            }
        };

        const defaultGuides = [
            { id: 1, title: "ÂÖ•Â¢ÉËàáÁ∂≤Ë∑Ø", icon: "fas fa-plane-arrival", content: ["Ë®òÂæóÂÖàÂ°´ÂØ´ Visit Japan Web ‰∏¶Êà™Âúñ QR Code„ÄÇ", "Ê∫ñÂÇôÂØ¶È´îË•øÁìúÂç°ÊàñÊâãÊ©ü Apple Wallet Á∂ÅÂÆö Suica„ÄÇ", "‰∫ãÂÖà‰∏ãËºâ Google Maps Èõ¢Á∑öÂú∞ÂúñÂÇôÁî®„ÄÇ"] },
            { id: 2, title: "Ë≥ºÁâ©ËàáÂÖçÁ®Ö", icon: "fas fa-shopping-bag", content: ["Èö®Ë∫´ÊîúÂ∏∂Ë≠∑ÁÖßÊ≠£Êú¨ÔºåÂñÆÂ∫óÊªø 5,000 Êó•ÂúìÂèØÈÄÄÁ®Ö„ÄÇ", "ÂÖçÁ®ÖÂìÅÂú®Êó•Êú¨‰∏çÂèØÊãÜÂ∞ÅÔºàÊ®ôË®ªÊ∂àËÄóÂìÅÈ°ûËÄÖÔºâ„ÄÇ", "ÂøÖÈÄõÊé®Ëñ¶Ôºö3COINS, ÈäÄÂ∫ß‰∏âË∂ä B2 Ë≤ªÂçóÈõ™, Loft„ÄÇ"] },
            { id: 3, title: "Êó•Êú¨Á¶ÆÂÑÄ", icon: "fas fa-heart", content: ["Ë°óÈÅìÂæàÂ∞ëÂûÉÂúæÊ°∂ÔºåÂª∫Ë≠∞Èö®Ë∫´Â∏∂ÂÄãÂ∞èÂ°ëËÜ†Ë¢ãË£ùÂûÉÂúæ„ÄÇ", "Êê≠‰πòÂú∞ÈêµÊôÇË´ã‰øùÊåÅÂÆâÈùúÔºåÊâãÊ©üË™øËá≥ÈùúÈü≥Ê®°Âºè„ÄÇ", "ÁµêÂ∏≥ÊôÇÂ∞áÈå¢ÊîæÂú®Â∞àÁî®Â∞èÊâòÁõ§‰∏ä„ÄÇ"] },
            { id: 4, title: "ÂØåÂ£´Â±±ÊîªÁï•", icon: "fas fa-mountain", content: ["Ê≤≥Âè£ÊπñÊ∏ÖÊô®Ê•µÂÜ∑ÔºàÂèØÈÅî 0¬∞C ‰ª•‰∏ãÔºâÔºåÂãôÂøÖÊ¥ãËî•ÂºèÁ©øÊ≥ï„ÄÇ", "ÂØåÂ£´ÂõûÈÅäÂàóËªäÂº∑ÁÉàÂª∫Ë≠∞ÊèêÊó©‰∏ÄÂÄãÊúàÈ†êÁ¥Ñ„ÄÇ", "ÊãçÁÖßË´ãÊ≥®ÊÑèÂÆâÂÖ®ËàáÁï∂Âú∞Ë¶èÁØÑÔºåÂãøÈòªÁ§ô‰∫§ÈÄö„ÄÇ"] }
        ];

        // --- ÁãÄÊÖãËÆäÊï∏ ---
        let tripData = {};
        let ledgerData = [];
        let guideData = [];
        let currentDay = 'day1';

        // --- ÂàùÂßãÂåñËàáÂ≠òÂÑ≤ ---
        function init() {
            // Âæû LocalStorage ËÆÄÂèñË≥áÊñô
            const storedTrip = localStorage.getItem('tokyo_trip_data_v2');
            const storedLedger = localStorage.getItem('tokyo_ledger_data_v2');
            const storedGuides = localStorage.getItem('tokyo_guides_data_v2');

            tripData = storedTrip ? JSON.parse(storedTrip) : JSON.parse(JSON.stringify(defaultTripData));
            ledgerData = storedLedger ? JSON.parse(storedLedger) : [];
            guideData = storedGuides ? JSON.parse(storedGuides) : JSON.parse(JSON.stringify(defaultGuides));

            // Â¶ÇÊûúËàäË≥áÊñôÊ≤íÊúâ hourlyÔºåË£ú‰∏äÁ©∫Èô£Âàó
            for(let key in tripData) {
                if(!tripData[key].weather.hourly) tripData[key].weather.hourly = [];
            }

            renderTabs();
            renderDay(currentDay);
            renderLedger();
            renderGuides();
        }

        function saveData() {
            localStorage.setItem('tokyo_trip_data_v2', JSON.stringify(tripData));
            localStorage.setItem('tokyo_ledger_data_v2', JSON.stringify(ledgerData));
            localStorage.setItem('tokyo_guides_data_v2', JSON.stringify(guideData));
        }

        // --- Ë°åÁ®ãÂäüËÉΩ ---
        function renderTabs() {
            const container = document.getElementById('day-tabs');
            container.innerHTML = Object.keys(tripData).map(key => `
                <div class="tab-item ${key === currentDay ? 'active' : ''}" onclick="selectDay('${key}')">
                    ${tripData[key].date}
                </div>
            `).join('');
        }

        function selectDay(key) {
            currentDay = key;
            renderTabs();
            renderDay(key);
        }

        function renderDay(dayKey) {
            const data = tripData[dayKey];
            const container = document.getElementById('day-content');
            
            // Ê∏≤ÊüìÊôÇÊÆµÂ§©Ê∞£
            let hourlyHTML = data.weather.hourly.map((h, idx) => `
                <div class="hourly-item" onclick="editHourly(${idx})">
                    <span class="h-time" contenteditable="true" onblur="updateHourly(${idx}, 'time', this.innerText)">${h.time}</span>
                    <span class="h-icon" contenteditable="true" onblur="updateHourly(${idx}, 'icon', this.innerText)">${h.icon}</span>
                    <span class="h-temp" contenteditable="true" onblur="updateHourly(${idx}, 'temp', this.innerText)">${h.temp}</span>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="weather-card">
                    <div class="weather-main">
                        <div class="weather-info">
                            <span class="temp-display" contenteditable="true" onblur="updateDayField('weather', 'temp', this.innerText)">${data.weather.temp}</span>
                            <span>
                                <span contenteditable="true" onblur="updateDayField('weather', 'icon', this.innerText)">${data.weather.icon}</span> 
                                <span contenteditable="true" onblur="updateDayField('weather', 'desc', this.innerText)">${data.weather.desc}</span>
                            </span>
                        </div>
                        <button class="btn-icon add" onclick="addHourlyItem()" style="font-size:1.2rem;">+</button>
                    </div>
                    <div class="hourly-weather-scroll">
                        ${hourlyHTML.length > 0 ? hourlyHTML : '<div style="color:#aaa; font-size:0.8rem; padding:10px;">ÈªûÊìä + Êñ∞Â¢ûÊôÇÊÆµÂ§©Ê∞£</div>'}
                    </div>
                    <div class="outfit-box"><b>üëó Á©øÊê≠Ôºö</b><span contenteditable="true" onblur="updateDayField('weather', 'outfit', this.innerText)">${data.weather.outfit}</span></div>
                </div>
                
                <div class="hotel-card">
                    <span contenteditable="true" onblur="updateDayField('hotel', null, this.innerText)">${data.hotel}</span>
                </div>
                
                <div id="sortable-list">
                    ${data.items.map((item, index) => `
                        <div class="timeline-item" data-id="${index}">
                            <div class="map-trigger" onclick="window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent('${item.addr}'))">
                                <i class="fas fa-map-marker-alt"></i> Â∞éËà™
                            </div>
                            <div class="item-content">
                                <i class="fas fa-times delete-item-btn" onclick="deleteItem(${index})"></i>
                                <span class="item-time" contenteditable="true" onblur="updateItem(${index}, 'time', this.innerText)">${item.time}</span>
                                <div class="item-title" contenteditable="true" onblur="updateItem(${index}, 'title', this.innerText)">${item.title}</div>
                                <span class="tag ${item.type}" onclick="toggleType(${index})">${item.type === 'food' ? 'ÁæéÈ£ü' : (item.type === 'shop' ? 'Ë≥ºÁâ©' : 'ÊôØÈªû')}</span>
                                <p style="font-size:0.8rem; color:#888; margin:5px 0 0 0;" contenteditable="true" onblur="updateItem(${index}, 'desc', this.innerText)">${item.desc}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="notes-area"><b>üìù ÂÇôË®ªÔºö</b><span contenteditable="true" onblur="updateDayField('note', null, this.innerText)">${data.note}</span></div>
            `;

            const el = document.getElementById('sortable-list');
            new Sortable(el, {
                animation: 150,
                handle: '.timeline-item',
                delay: 200, delayOnTouchOnly: true,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const movedItem = tripData[dayKey].items.splice(evt.oldIndex, 1)[0];
                    tripData[dayKey].items.splice(evt.newIndex, 0, movedItem);
                    saveData();
                }
            });
        }

        // --- Ë°åÁ®ãË≥áÊñôÊõ¥Êñ∞ÈÇèËºØ ---
        function updateDayField(field, subField, value) {
            if (subField) tripData[currentDay][field][subField] = value;
            else tripData[currentDay][field] = value;
            saveData();
        }

        function updateItem(index, field, value) {
            tripData[currentDay].items[index][field] = value;
            saveData();
        }

        function updateHourly(index, field, value) {
            tripData[currentDay].weather.hourly[index][field] = value;
            saveData();
        }

        function toggleType(index) {
            const types = ['spot', 'food', 'shop', 'transport'];
            const currentType = tripData[currentDay].items[index].type;
            const nextType = types[(types.indexOf(currentType) + 1) % types.length];
            tripData[currentDay].items[index].type = nextType;
            renderDay(currentDay);
            saveData();
        }

        function addItem() {
            tripData[currentDay].items.push({
                time: '00:00', title: 'Êñ∞Ë°åÁ®ã', type: 'spot', addr: '', desc: 'ÈªûÊìäÁ∑®ËºØÂÖßÂÆπ'
            });
            renderDay(currentDay);
            saveData();
        }

        function deleteItem(index) {
            if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë°åÁ®ãÔºü')) {
                tripData[currentDay].items.splice(index, 1);
                renderDay(currentDay);
                saveData();
            }
        }

        function addHourlyItem() {
            tripData[currentDay].weather.hourly.push({ time: '--:--', icon: '‚òÄÔ∏è', temp: '--¬∞C' });
            renderDay(currentDay);
            saveData();
        }

        // --- ÊîªÁï•ÂäüËÉΩ (Data Driven) ---
        function renderGuides() {
            const container = document.getElementById('guide-list-container');
            container.innerHTML = guideData.map((guide, gIndex) => `
                <div class="guide-section">
                    <div class="guide-title">
                        <i class="${guide.icon}"></i> 
                        <span contenteditable="true" onblur="updateGuideTitle(${gIndex}, this.innerText)">${guide.title}</span>
                    </div>
                    <div class="guide-card">
                        <div class="guide-controls">
                            <button class="btn-icon add" onclick="addGuideItem(${gIndex})"><i class="fas fa-plus"></i></button>
                            <button class="btn-icon del" onclick="deleteGuideSection(${gIndex})"><i class="fas fa-times"></i></button>
                        </div>
                        <ul>
                            ${guide.content.map((item, cIndex) => `
                                <li contenteditable="true" onblur="updateGuideContent(${gIndex}, ${cIndex}, this.innerText)">${item}</li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `).join('');
        }

        function addGuideSection() {
            guideData.unshift({
                id: Date.now(), title: "Êñ∞ÊîªÁï•ÂçÄÂ°ä", icon: "fas fa-info-circle", content: ["ÈªûÊìäÊ≠§ËôïÁ∑®ËºØÂÖßÂÆπ"]
            });
            renderGuides();
            saveData();
        }

        function deleteGuideSection(index) {
            if(confirm('Âà™Èô§Ê≠§ÊîªÁï•ÂçÄÂ°äÔºü')) {
                guideData.splice(index, 1);
                renderGuides();
                saveData();
            }
        }

        function addGuideItem(gIndex) {
            guideData[gIndex].content.push("Êñ∞È†ÖÁõÆ...");
            renderGuides();
            saveData();
        }

        function updateGuideTitle(gIndex, val) {
            guideData[gIndex].title = val;
            saveData();
        }

        function updateGuideContent(gIndex, cIndex, val) {
            guideData[gIndex].content[cIndex] = val;
            saveData();
        }

        // --- Â∏≥Êú¨ÂäüËÉΩ ---
        function addLedgerItem() {
            const nameInput = document.getElementById('expense-name');
            const jpyInput = document.getElementById('expense-jpy');
            
            if (nameInput.value && jpyInput.value) {
                const item = {
                    id: Date.now(),
                    name: nameInput.value,
                    jpy: parseFloat(jpyInput.value),
                    twd: Math.round(parseFloat(jpyInput.value) * JPY_RATE)
                };
                ledgerData.unshift(item); // Add to top
                nameInput.value = '';
                jpyInput.value = '';
                renderLedger();
                saveData();
            }
        }

        function deleteLedgerItem(id) {
            ledgerData = ledgerData.filter(item => item.id !== id);
            renderLedger();
            saveData();
        }

        function clearLedger() {
            if(confirm('Á¢∫ÂÆöÊ∏ÖÁ©∫ÊâÄÊúâÂ∏≥Êú¨Á¥ÄÈåÑÔºüÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                ledgerData = [];
                renderLedger();
                saveData();
            }
        }

        function renderLedger() {
            const container = document.getElementById('ledger-list');
            let totalTwd = 0;
            container.innerHTML = ledgerData.map((item) => {
                totalTwd += item.twd;
                return `
                    <div class="ledger-item">
                        <span>${item.name}</span>
                        <div style="display:flex; align-items:center;">
                            <span style="color:var(--text-secondary);">¬•${item.jpy} ‚Üí <b>NT$ ${item.twd}</b></span>
                            <i class="fas fa-times delete-ledger" onclick="deleteLedgerItem(${item.id})"></i>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('total-twd').innerText = `NT$ ${totalTwd.toLocaleString()}`;
            document.getElementById('split-result').innerText = `4 ‰∫∫ÂàÜÂ∏≥ÔºöÊØè‰∫∫ NT$ ${Math.round(totalTwd / 4).toLocaleString()}`;
        }

        function switchPage(page) {
            document.getElementById('page-itinerary').style.display = page === 'itinerary' ? 'block' : 'none';
            document.getElementById('page-notices').style.display = page === 'notices' ? 'block' : 'none';
            document.getElementById('page-ledger').style.display = page === 'ledger' ? 'block' : 'none';
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText.includes(
                    page === 'itinerary' ? 'Ë°åÁ®ã' : (page === 'ledger' ? 'Â∏≥Êú¨' : 'ÊîªÁï•')
                ));
            });
        }

        init();
    </script>
</body>
</html>
