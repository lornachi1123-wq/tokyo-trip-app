<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FDFBF7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>æ±äº¬æ—…è¨˜ Tokyo Trip</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Shippori+Mincho:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            /* ç±³è‰²ç³»æ—¥å¼é…è‰² */
            --bg-color: #FDFBF7;        /* ç”Ÿæˆã‚Šè‰² (åŸºåº•) */
            --card-bg: #FFFFFF;         /* ç™½ */
            --text-primary: #4A4036;    /* æ·±èƒ¡æ¡ƒ */
            --text-secondary: #8C837B;  /* ç°è¤ */
            --accent: #C7B398;          /* äºéº»è‰² */
            --highlight: #D4A373;       /* æ¯èŒ¶è‰² (é‡é») */
            --nav-active: #8D7B68;
            --shadow: 0 4px 12px rgba(74, 64, 54, 0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            padding-bottom: 90px;
            overscroll-behavior-y: none;
        }

        /* --- é ‚éƒ¨å°èˆª --- */
        header {
            position: sticky;
            top: 0;
            background: rgba(253, 251, 247, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            padding-top: max(15px, env(safe-area-inset-top));
        }
        .app-title { font-family: 'Shippori Mincho', serif; font-size: 1.4rem; font-weight: 600; color: var(--text-primary); }
        .add-btn { font-size: 1.2rem; color: var(--text-primary); background: none; border: none; cursor: pointer; }

        /* --- æ—¥æœŸ Tabs --- */
        .tabs-wrapper {
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 20px;
            background: var(--bg-color);
            scrollbar-width: none;
        }
        .tabs-wrapper::-webkit-scrollbar { display: none; }
        .tab-item {
            display: inline-block;
            padding: 8px 18px;
            margin-right: 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: #F2EFE9;
            transition: all 0.3s;
        }
        .tab-item.active { background: var(--nav-active); color: #fff; box-shadow: var(--shadow); }

        /* --- ä¸»è¦å…§å®¹å€ --- */
        .section-container { padding: 0 20px; animation: fadeIn 0.4s ease; }
        
        /* 1. å¤©æ°£å±¤ */
        .weather-card {
            background: linear-gradient(135deg, #FFFDF9 0%, #F5F1E8 100%);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
        }
        .weather-main { display: flex; align-items: center; gap: 15px; }
        .temp-display { font-size: 2rem; font-family: 'Shippori Mincho', serif; font-weight: 600; }
        .advice-box { 
            margin-top: 10px; padding-top: 10px; 
            border-top: 1px dashed #DCC; 
            font-size: 0.85rem; line-height: 1.5; color: var(--text-secondary);
        }

        /* 2. ä½å®¿å±¤ */
        .hotel-card {
            background: #FFFFFF;
            border-left: 4px solid var(--accent);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        /* 3. æ™¯é»è¡Œç¨‹å±¤ */
        .timeline-item {
            background: var(--card-bg);
            border-radius: var(--radius);
            margin-bottom: 16px;
            display: flex;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.1s;
        }
        /* å·¦å´å°èˆªæŒ‰éˆ•å€ */
        .map-trigger {
            width: 60px;
            background: #F4F1EC;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            border-right: 1px solid #eee;
            cursor: pointer;
        }
        .map-icon { font-size: 1.2rem; margin-bottom: 4px; color: var(--highlight); }
        
        /* å³å´å…§å®¹å€ */
        .item-content { flex: 1; padding: 15px; position: relative; }
        .item-time { font-size: 0.9rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; display: block;}
        .item-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); }
        .item-tags { display: flex; gap: 8px; font-size: 0.75rem; }
        .tag { padding: 2px 8px; border-radius: 4px; background: #eee; color: #666; }
        .tag.food { background: #FFECB3; color: #8D6E63; }
        .tag.shop { background: #FFCDD2; color: #C62828; }
        .tag.spot { background: #B3E5FC; color: #0277BD; }

        /* 4. æ³¨æ„äº‹é …å±¤ */
        .notes-area {
            background: #FFF; border: 1px dashed #CCC; border-radius: var(--radius);
            padding: 15px; min-height: 80px; margin-bottom: 30px;
            font-size: 0.9rem; line-height: 1.6; color: var(--text-secondary);
        }

        /* --- åº•éƒ¨å°èˆª --- */
        .bottom-nav {
            position: fixed;
            bottom: 0; width: 100%;
            background: rgba(255,255,255,0.98);
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            z-index: 99;
        }
        .nav-btn {
            border: none; background: none;
            display: flex; flex-direction: column; align-items: center;
            color: #BBB; font-size: 0.7rem; gap: 4px;
        }
        .nav-btn.active { color: var(--nav-active); }
        .nav-btn i { font-size: 1.2rem; }

        /* --- Modal è©³ç´°é  --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 200;
            display: none; align-items: flex-end;
        }
        .modal-overlay.open { display: flex; }
        .modal-sheet {
            background: #FFF; width: 100%;
            border-radius: 24px 24px 0 0;
            padding: 24px; max-height: 85vh; overflow-y: auto;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        /* Modal å…§å®¹æ¨£å¼ */
        .detail-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .detail-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
        .detail-meta { font-size: 0.9rem; color: #888; display: flex; gap: 15px; }
        
        .info-block { margin-bottom: 20px; }
        .info-label { font-size: 0.85rem; color: var(--highlight); font-weight: 600; margin-bottom: 8px; display: block; }
        .info-text { font-size: 0.95rem; line-height: 1.6; color: #555; white-space: pre-line; }
        
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #FAFAFA; font-size: 1rem;}
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--text-primary); color: #fff; }
        .btn-outline { background: #f0f0f0; color: #333; }

        /* --- å¸³æœ¬é æ¨£å¼ --- */
        .wallet-card { background: #FFF; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 15px; }
        .total-display { text-align: center; margin-bottom: 20px; }
        .big-price { font-size: 2.2rem; font-weight: 700; color: var(--text-primary); font-family: 'Shippori Mincho'; }
        .sub-price { font-size: 0.9rem; color: #888; }
        .split-box { background: #F9F9F9; padding: 10px; border-radius: 8px; text-align: center; margin-top: 10px;}
        .expense-list { list-style: none; padding: 0; }
        .expense-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #eee; }

        /* æ‹–æ›³æ¨£å¼ */
        .sortable-ghost { opacity: 0.4; background: #eee; }
        .sortable-drag { transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

    </style>
</head>
<body>

    <div id="page-itinerary">
        <header>
            <div class="app-title">æ±äº¬æ—…è¨˜ <span style="font-size:0.8rem; color:#888;">Dec 25-27</span></div>
            <button class="add-btn" onclick="openEditModal(null)"><i class="fas fa-plus"></i></button>
        </header>

        <div class="tabs-wrapper" id="day-tabs">
            </div>

        <div id="day-content" class="section-container">
            </div>
    </div>

    <div id="page-wallet" style="display:none;">
        <header>
            <div class="app-title">æ—…éŠå¸³æœ¬ & å·¥å…·</div>
        </header>
        <div class="section-container" style="padding-top: 20px;">
            
            <div class="hotel-card" style="display:block; border-left-color: #5D4037;">
                <div style="font-weight:700; margin-bottom:5px;">âœˆï¸ èˆªç­è³‡è¨Š</div>
                <div style="font-size:0.9rem; line-height:1.6;">
                    å»ç¨‹ CI108: 12/25 14:25 TPE â” 18:30 NRT<br>
                    å›ç¨‹ CI109: 12/31 19:30 NRT â” 22:45 TPE
                </div>
            </div>

            <div class="hotel-card" style="background:#FFF0F0; border-left-color:#E57373;" onclick="alert('è«‹åƒè€ƒ Day 3 è¡Œç¨‹ä¸­çš„è³¼ç‰©è©³ç´°è³‡è¨Šï¼')">
                <b>ğŸ›ï¸ å¿…è²·æ¸…å–®å°ˆå€</b>
                <span style="font-size:0.8rem; color:#888;">Loft, Muji, Uniqlo, 3COINS...</span>
            </div>

            <div class="wallet-card">
                <div class="total-display">
                    <div style="font-size:0.9rem; color:#888;">ç›®å‰ç¸½èŠ±è²» (æ—¥å¹£)</div>
                    <div class="big-price" id="total-jpy">Â¥0</div>
                    <div class="sub-price">ç´„ NT$ <span id="total-twd">0</span> (åŒ¯ç‡ 0.22)</div>
                    
                    <div class="split-box">
                        <span style="color:#666; font-size:0.8rem;">åˆ†å¸³ (4äºº)</span><br>
                        <b id="split-price" style="font-size:1.1rem; color:#4A4036;">NT$ 0 /äºº</b>
                    </div>
                </div>

                <h4 style="margin-bottom:10px;">æ–°å¢æ”¯å‡º</h4>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="expense-name" class="form-input" placeholder="é …ç›® (å¦‚: æ™šé¤)" style="margin:0; flex:2;">
                    <input type="number" id="expense-cost" class="form-input" placeholder="Â¥ é‡‘é¡" style="margin:0; flex:1;">
                    <button class="btn btn-primary" style="padding:10px; flex:0.8;" onclick="addExpense()">è¨˜å¸³</button>
                </div>

                <h4 style="margin-bottom:10px; border-top:1px solid #eee; padding-top:10px;">æ”¯å‡ºæ˜ç´°</h4>
                <ul class="expense-list" id="expense-list">
                    </ul>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchPage('itinerary')">
            <i class="fas fa-calendar-alt"></i> è¡Œç¨‹
        </button>
        <button class="nav-btn" onclick="switchPage('wallet')">
            <i class="fas fa-wallet"></i> å¸³æœ¬/å·¥å…·
        </button>
    </nav>

    <div class="modal-overlay" id="detail-modal">
        <div class="modal-sheet">
            <div class="detail-header">
                <input type="text" id="modal-title" class="detail-title form-input" style="border:none; padding:0; background:transparent; font-size:1.5rem;" placeholder="è¡Œç¨‹åç¨±">
                <div class="detail-meta">
                    <input type="time" id="modal-time" style="border:1px solid #eee; padding:5px; border-radius:5px;">
                    <select id="modal-type" style="border:1px solid #eee; padding:5px; border-radius:5px;">
                        <option value="spot">æ™¯é»</option>
                        <option value="food">ç¾é£Ÿ</option>
                        <option value="shop">è³¼ç‰©</option>
                        <option value="transport">äº¤é€š</option>
                    </select>
                </div>
            </div>

            <div class="info-block">
                <label class="info-label">ğŸ“ å°èˆªåœ°å€ (é»å·¦å´åœ°åœ–æŒ‰éˆ•è·³è½‰)</label>
                <input type="text" id="modal-addr" class="form-input" placeholder="Google Map åœ°å€">
            </div>

            <div class="info-block">
                <label class="info-label">ğŸ’¡ å°éŠä»‹ç´¹ / ç‡Ÿæ¥­æ™‚é–“ / å¿…è²·æ¨è–¦</label>
                <textarea id="modal-desc" class="form-input" rows="6" style="line-height:1.6;"></textarea>
            </div>
            
            <div class="info-block">
                <label class="info-label">ğŸ’° é ä¼°èŠ±è²» (æ—¥å¹£)</label>
                <input type="number" id="modal-cost" class="form-input" placeholder="0">
            </div>

            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveModal()">å„²å­˜è®Šæ›´</button>
                <button class="btn btn-outline" onclick="closeModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // --- è³‡æ–™åˆå§‹åŒ– (åŸºæ–¼ PDF å…§å®¹ [cite: 5, 10, 16, 19]) ---
        const tripData = {
            day1: {
                date: "12/25 (ä¸‰)",
                weather: { temp: "8Â°C", icon: "â˜ï¸", desc: "é™°çŸ­æš«é›¨" },
                advice: "æŠµé”æ—¥é‡é»ï¼šSkyliner 18:30 å¾Œç­æ¬¡ã€‚æ™šé¤å…­å˜èˆå¯èƒ½æ’éšŠï¼Œå»ºè­° 22:00 å‰æŠµé”ã€‚",
                hotel: "ğŸ  ä½å®¿: 3 Chome-4-1 Narihira (æŠ¼ä¸Šç«™æ­¥è¡Œ10åˆ†)",
                note: "å…¥å¢ƒå¾Œè¨˜å¾—å»äº¬æˆé›»éµæ«ƒå°é ˜ Skyliner è»Šç¥¨ ã€‚",
                items: [
                    { id: '1', time: '18:30', title: 'æŠµé”æˆç”°æ©Ÿå ´ (NRT)', type: 'transport', addr: 'Narita Airport', desc: 'å…¥å¢ƒå¯©æŸ¥ã€é ˜è¡Œæã€‚\nå‰å¾€äº¬æˆé›»éµæ«ƒæª¯é ˜å– Skyliner è»Šç¥¨ã€‚', cost: 0 },
                    { id: '2', time: '19:30', title: 'Skyliner å¾€é’ç ¥', type: 'transport', addr: 'Narita Airport Station', desc: 'æ­ä¹˜ Skyliner (å¾€äº¬æˆä¸Šé‡æ–¹å‘)ã€‚\nç´„40åˆ†é˜è»Šç¨‹ã€‚å…¨è»Šå°è™Ÿåº§ ã€‚', cost: 2570 },
                    { id: '3', time: '20:10', title: 'é’ç ¥ç«™è½‰ä¹˜', type: 'transport', addr: 'Aoto Station', desc: 'ä¸‹è»ŠåŒæœˆå°è½‰ä¹˜ã€Œäº¬æˆæŠ¼ä¸Šç·šã€(å¾€æŠ¼ä¸Š/ç¾½ç”°æ–¹å‘)ã€‚', cost: 0 },
                    { id: '4', time: '20:25', title: 'Check-in æŠ¼ä¸Šä½å®¿', type: 'spot', addr: '3 Chome-4-1 Narihira', desc: 'æŠ¼ä¸Šç«™å‡ºç«™æ­¥è¡Œç´„ 10-15 åˆ†é˜ã€‚\nè»Šç«™æœ‰é›»æ¢¯æ–¹ä¾¿æ‹–è¡Œæã€‚', cost: 0 },
                    { id: '5', time: '21:30', title: 'æ™šé¤ï¼šå…­å˜èˆ', type: 'food', addr: 'Rokurinsha Tokyo Solamachi', desc: 'ã€å°éŠæ¨è–¦ã€‘\nä½ç½®ï¼šæ™´ç©ºå¡” Solamachi 6F\nå¿…åƒï¼šç‰¹è£½æ²¾éºµ (æ¿ƒåšè±šéª¨é­šä»‹)\nç‡Ÿæ¥­æ™‚é–“ï¼š10:30~23:00 (L.O 22:30) ', cost: 1500 }
                ]
            },
            day2: {
                date: "12/26 (å››)",
                weather: { temp: "6Â°C", icon: "â˜€ï¸", desc: "æ™´æœ—åå†·" },
                advice: "è¿ªå£«å°¼å…¨æ—¥ï¼šå‹™å¿… 07:45 å‰å‡ºç™¼ã€‚å…¥åœ’å¾Œç¬¬ä¸€ä»¶äº‹æŠ½ DPA (ç¾å¥³èˆ‡é‡ç¸) ã€‚",
                hotel: "ğŸ  ä½å®¿: 3 Chome-4-1 Narihira",
                note: "é–‰åœ’å¾Œäº¬è‘‰ç·šäººæ½®å¤šï¼Œå»ºè­°ææ—©æˆ–æ™šé»é›¢é–‹ã€‚",
                items: [
                    { id: '6', time: '07:45', title: 'å‡ºç™¼å¾€èˆæ¿±', type: 'transport', addr: 'Oshiage Station', desc: 'æŠ¼ä¸Š -> èˆæ¿± (ä½¿ç”¨ä¹˜æ›æ¡ˆå…§æŸ¥è©¢ç•¶æ—¥æœ€å¿«è·¯ç·š)ã€‚', cost: 400 },
                    { id: '7', time: '09:00', title: 'æ±äº¬è¿ªå£«å°¼æ¨‚åœ’', type: 'spot', addr: 'Tokyo Disneyland', desc: 'ã€æ”»ç•¥é‡é»ã€‘\n1. å…¥åœ’ç«‹åˆ»è²· DPAï¼šç¾å¥³èˆ‡é‡ç¸ (æœ€ç†±é–€)\n2. æŠ½è¡¨æ¼”ç§€ (Entry Request)\n3. å»ºè­°è¨­æ–½ï¼šæ¯éºµæ­¡æ¨‚ä¹‹æ—…ã€é£›æ¿ºå±± ', cost: 9400 },
                    { id: '8', time: '12:00', title: 'æ¨‚åœ’åˆé¤', type: 'food', addr: 'Tokyo Disneyland', desc: 'æ¨è–¦å°åƒï¼šä¸‰çœ¼æ€ªéº»ç³¬ã€ç±³å¥‡å‰æ‹¿æ£’ã€çˆ†ç±³èŠ±æ¡¶ã€‚', cost: 2000 },
                    { id: '9', time: '21:00', title: 'ç…™ç« / éŠè¡Œ', type: 'spot', addr: 'Tokyo Disneyland', desc: 'Reach for the Stars / é›»å­å¤§éŠè¡Œ å¤¢ä¹‹å…‰ [cite: 15]ã€‚', cost: 0 },
                    { id: '10', time: '22:30', title: 'è¿”å›æŠ¼ä¸Š', type: 'transport', addr: 'Maihama Station', desc: 'èˆæ¿±ç«™ -> æŠ¼ä¸Šç«™', cost: 400 }
                ]
            },
            day3: {
                date: "12/27 (äº”)",
                weather: { temp: "9Â°C", icon: "ğŸŒ¤ï¸", desc: "å¤šé›²æ™‚æ™´" },
                advice: "è³¼ç‰©æ—¥ï¼šä»ŠåŠå£½å–œç‡’å·²é ç´„ 13:00ï¼Œè«‹æº–æ™‚ã€‚è³¼ç‰©æ¸…å–®é›†ä¸­åœ¨éŠ€åº§ã€‚",
                hotel: "ğŸ  ä½å®¿: 3 Chome-4-1 Narihira",
                note: "éŠ€åº§è³¼ç‰©è«‹å–„ç”¨ Google Maps æ­¥è¡Œå°èˆªã€‚",
                items: [
                    { id: '11', time: '09:00', title: 'å‰å¾€æ·ºè‰', type: 'transport', addr: 'Asakusa Station', desc: 'éƒ½ç‡Ÿæ·ºè‰ç·šï¼šæŠ¼ä¸Š -> æ·ºè‰ (A4å‡ºå£)', cost: 180 },
                    { id: '12', time: '10:00', title: 'æ·ºè‰æ„›å’Œæœ & é›·é–€', type: 'spot', addr: 'Asakusa Aiwafuku 3', desc: 'æ›å’Œæœ -> é›·é–€æ‹ç…§ -> ä»²è¦‹ä¸–é€šé€›è¡— ã€‚', cost: 5000 },
                    { id: '13', time: '13:00', title: 'åˆé¤ï¼šæ·ºè‰ä»ŠåŠ', type: 'food', addr: 'Asakusa Imahan Kokusai Dori', desc: 'ã€å·²é ç´„ã€‘ç™¾å¹´å£½å–œç‡’è€åº— ã€‚\nå¿…åƒï¼šé»‘æ¯›å’Œç‰›å£½å–œç‡’åˆé–“å¥—é¤ã€‚', cost: 8000 },
                    { id: '14', time: '14:30', title: 'å°ç¶²ç¥ç¤¾', type: 'spot', addr: 'Koami Shrine', desc: 'å¼·é‹é™¤å„ï¼æ´—éŒ¢å¼è²¡å¤©ã€‚äººå½¢ç”ºç«™ A5 å‡ºå£æ­¥è¡Œ [cite: 18]ã€‚', cost: 0 },
                    { id: '15', time: '16:00', title: 'éŠ€åº§è³¼ç‰©: Loft & MUJI', type: 'shop', addr: 'Ginza Loft', desc: 'ã€è³¼ç‰©æ¸…å–®ã€‘\n1. Loft: æ‰‹å¸³ã€æ–‡å…·ã€å…¥æµ´åŠ‘ \n2. MUJI: æ——è‰¦åº—åˆºç¹¡æœå‹™ã€å’–å“©åŒ…ã€å¹´è¼ªè›‹ç³• [cite: 26]', cost: 5000 },
                    { id: '16', time: '17:30', title: 'éŠ€åº§è³¼ç‰©: Uniqlo & 3COINS', type: 'shop', addr: 'Uniqlo Ginza', desc: 'ã€è³¼ç‰©æ¸…å–®ã€‘\n1. Uniqlo: 12F æ——è‰¦åº—é™å®š T-shirt [cite: 31]\n2. 3COINS: è³ªæ„Ÿå»šæˆ¿å°ç‰© (300å††) [cite: 36]', cost: 8000 },
                    { id: '17', time: '19:00', title: 'ä¼´æ‰‹ç¦®: noix de beurre', type: 'shop', addr: 'Ginza Mitsukoshi', desc: 'ä½ç½®ï¼šéŠ€åº§ä¸‰è¶Š B2F [cite: 41]\nå¿…è²·ï¼šå‰›å‡ºçˆçš„è²»å—é›ª (Financier)ï¼Œæ’éšŠååº—ï¼', cost: 3000 }
                ]
            }
        };

        let currentDay = 'day1';
        let expenses = []; // { name, cost }

        // --- æ ¸å¿ƒé‚è¼¯ ---

        function init() {
            renderTabs();
            renderDay(currentDay);
            loadExpenses();
            updateTotal();
        }

        function renderTabs() {
            const container = document.getElementById('day-tabs');
            container.innerHTML = '';
            Object.keys(tripData).forEach(key => {
                const btn = document.createElement('div');
                btn.className = `tab-item ${key === currentDay ? 'active' : ''}`;
                btn.innerText = tripData[key].date;
                btn.onclick = () => { currentDay = key; renderTabs(); renderDay(key); };
                container.appendChild(btn);
            });
        }

        function renderDay(dayKey) {
            const data = tripData[dayKey];
            const container = document.getElementById('day-content');
            
            // 1. å¤©æ°£èˆ‡å»ºè­°
            let html = `
                <div class="weather-card">
                    <div>
                        <div style="font-size:0.8rem; color:#888;">ç•¶åœ°æ°£è±¡</div>
                        <div class="weather-main">
                            <span class="temp-display">${data.weather.temp}</span>
                            <span>${data.weather.icon}<br>${data.weather.desc}</span>
                        </div>
                    </div>
                    <div style="flex:1; margin-left:15px;">
                        <span style="font-weight:600; font-size:0.9rem; color:#D4A373;">ğŸ’¡ æ—…è¡Œå»ºè­°</span>
                        <div class="advice-box">${data.advice}</div>
                    </div>
                </div>
            `;

            // 2. ä½å®¿
            html += `
                <div class="hotel-card">
                    <span style="font-size:0.9rem;">${data.hotel}</span>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent('3 Chome-4-1 Narihira')}" target="_blank" style="text-decoration:none; color:var(--highlight);"><i class="fas fa-location-arrow"></i></a>
                </div>
            `;

            // 3. æ™‚é–“è»¸åˆ—è¡¨
            html += `<div id="timeline-list">`;
            data.items.forEach((item, index) => {
                let tagLabel = { 'spot': 'æ™¯é»', 'food': 'ç¾é£Ÿ', 'shop': 'è³¼ç‰©', 'transport': 'äº¤é€š' }[item.type];
                
                html += `
                    <div class="timeline-item" data-index="${index}" data-id="${item.id}">
                        <div class="map-trigger" onclick="openMap('${item.addr}')">
                            <i class="fas fa-map-marker-alt map-icon"></i>
                            <span>å°èˆª</span>
                        </div>
                        <div class="item-content" onclick="openEditModal(${index})">
                            <span class="item-time">${item.time}</span>
                            <div class="item-title">${item.title}</div>
                            <div class="item-tags">
                                <span class="tag ${item.type}">${tagLabel}</span>
                                ${item.cost > 0 ? `<span style="color:#888;">Â¥${item.cost.toLocaleString()}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            // 4. æ³¨æ„äº‹é …
            html += `
                <div class="notes-area">
                    <b>ğŸ“ ç­†è¨˜ / æ³¨æ„äº‹é …</b><br>
                    ${data.note}
                </div>
            `;

            container.innerHTML = html;

            // å•Ÿå‹•æ‹–æ›³æ’åº (æŒ‰å£“ 200ms)
            const listEl = document.getElementById('timeline-list');
            new Sortable(listEl, {
                animation: 150,
                delay: 200, 
                delayOnTouchOnly: true,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const item = tripData[dayKey].items.splice(evt.oldIndex, 1)[0];
                    tripData[dayKey].items.splice(evt.newIndex, 0, item);
                }
            });
        }

        // --- åŠŸèƒ½å‡½æ•¸ ---

        function openMap(addr) {
            if(!addr) return alert('æœªè¨­å®šåœ°å€');
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`, '_blank');
        }

        function switchPage(page) {
            document.getElementById('page-itinerary').style.display = page === 'itinerary' ? 'block' : 'none';
            document.getElementById('page-wallet').style.display = page === 'wallet' ? 'block' : 'none';
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // --- Modal é‚è¼¯ ---
        let editIndex = null;

        function openEditModal(index) {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('open');
            
            if (index !== null) {
                editIndex = index;
                const item = tripData[currentDay].items[index];
                document.getElementById('modal-title').value = item.title;
                document.getElementById('modal-time').value = item.time;
                document.getElementById('modal-type').value = item.type;
                document.getElementById('modal-addr').value = item.addr || '';
                document.getElementById('modal-desc').value = item.desc || '';
                document.getElementById('modal-cost').value = item.cost || '';
            } else {
                // æ–°å¢æ¨¡å¼
                editIndex = -1;
                document.getElementById('modal-title').value = '';
                document.getElementById('modal-time').value = '12:00';
                document.getElementById('modal-desc').value = '';
                document.getElementById('modal-cost').value = '';
            }
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.remove('open');
        }

        function saveModal() {
            const newItem = {
                id: Date.now().toString(),
                title: document.getElementById('modal-title').value,
                time: document.getElementById('modal-time').value,
                type: document.getElementById('modal-type').value,
                addr: document.getElementById('modal-addr').value,
                desc: document.getElementById('modal-desc').value,
                cost: parseInt(document.getElementById('modal-cost').value) || 0
            };

            if (editIndex === -1) {
                tripData[currentDay].items.push(newItem);
            } else {
                tripData[currentDay].items[editIndex] = newItem;
            }
            
            // ä¾æ™‚é–“æ’åº
            tripData[currentDay].items.sort((a,b) => a.time.localeCompare(b.time));
            
            closeModal();
            renderDay(currentDay);
        }

        // --- å¸³æœ¬é‚è¼¯ ---
        function loadExpenses() {
            // å¾ LocalStorage è®€å– (æ¨¡æ“¬)
            const saved = localStorage.getItem('japan_expenses');
            if(saved) expenses = JSON.parse(saved);
            renderExpenseList();
        }

        function addExpense() {
            const name = document.getElementById('expense-name').value;
            const cost = parseInt(document.getElementById('expense-cost').value);
            if(!name || !cost) return alert('è«‹è¼¸å…¥é …ç›®èˆ‡é‡‘é¡');
            
            expenses.push({ name, cost });
            localStorage.setItem('japan_expenses', JSON.stringify(expenses));
            
            document.getElementById('expense-name').value = '';
            document.getElementById('expense-cost').value = '';
            renderExpenseList();
            updateTotal();
        }

        function renderExpenseList() {
            const list = document.getElementById('expense-list');
            list.innerHTML = expenses.map((item, i) => `
                <li class="expense-item">
                    <span>${item.name}</span>
                    <span>Â¥${item.cost.toLocaleString()}</span>
                </li>
            `).join('');
            updateTotal();
        }

        function updateTotal() {
            let total = expenses.reduce((sum, item) => sum + item.cost, 0);
            
            // åŒæ™‚åŠ ä¸Šè¡Œç¨‹ä¸­çš„é ä¼°èŠ±è²»
            Object.values(tripData).forEach(day => {
                day.items.forEach(i => total += (i.cost || 0));
            });

            const rate = 0.22; // åŒ¯ç‡
            const twd = Math.round(total * rate);
            
            document.getElementById('total-jpy').innerText = 'Â¥' + total.toLocaleString();
            document.getElementById('total-twd').innerText = twd.toLocaleString();
            document.getElementById('split-price').innerText = 'NT$ ' + Math.round(twd / 4).toLocaleString() + ' /äºº';
        }

        init();
    </script>
</body>
</html>